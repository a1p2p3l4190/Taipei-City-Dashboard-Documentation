## Mechanism

For components to access the data stored in the `dashboard` database, query strings are stored in the `component` table of the `dashboardmanager` database.

When an API is called to request chart or history data, the backend server will first query the `dashboard` database using the query strings stored in the `component` table, and then parse the data into the format required by the frontend based on the `query_type`.

### Query String Format

Query strings can be any valid SQL query string that can be executed by the `dashboard` database. In addition, the query strings can also contain placeholders (`%s`) that will be replaced by specified time ranges (if specified in [the component config](/front-end/introduction-to-components)) to query data within a specific time frame. The values of the placeholders are automatically generated by the front-end.

For chart data, query strings can have 0 or 2 placeholders. If the query string has 0 placeholders, the query will return as is. If the query string has 2 placeholders, the query will return the data for the specified time range.

For history data, the query type defaults to `time` and query strings must have 3 placeholders. The first placeholder is the timestepunit (e.g. `day`, `week`, `month`, automatically calculated based on the start and end times), the second placeholder is the start time, and the third placeholder is the end time.

## Query Types

> **t01**
> We recommend that you familiarize yourself with the [chart data article](/front-end/chart-data) in the front-end docs before reading this section.

### two_d

**Target Query Result:**

```go
type TwoDimensionalData struct {
	Xaxis string  `gorm:"column:x_axis" json:"x"`
	Data  float64 `gorm:"column:data"   json:"y"`
}
```

**Parsed Into:**

```json
[
	{
		"data": [
			{ "x": "", "y": 17 },
			...
		]
	}
]
```

**Sample Query String:**

```sql
-- For '臺北市陳情系統 circular'
SELECT case_subtype AS x_axis, SUM(case_count) AS data
FROM app_calcu_weekly_hellotaipei
WHERE create_time BETWEEN '%s' AND '%s'
GROUP BY case_subtype ORDER BY data desc
```

### three_d

**Target Query Result:**

```go
type ThreeDimensionalData struct {
	Xaxis string `gorm:"column:x_axis"`
	Icon  string `gorm:"column:icon" OPTIONAL`
	Yaxis string `gorm:"column:y_axis"`
	Data  int    `gorm:"column:data"`
}
```

**Parsed Into:**

```json
{
	"categories": [...],
	"data": [
		{
			"name": "",
			"icon": "",
			"data": [...]
		},
		...
	]
}
```

**Sample Query String:**

```sql
-- For '全市屋齡分布 building_age'
SELECT tname AS x_axis, age AS y_axis, COUNT(age) AS data FROM
	(
		SELECT
			tname,
			CASE WHEN age_2021<=5 THEN '<=5年' WHEN age_2021>5 AND age_2021<=20 THEN '5-20年' WHEN age_2021>20 AND age_2021<=40 THEN '20-40年' WHEN age_2021>40 THEN '>40年' ELSE '無' END age
			FROM building_age
	) AS t
WHERE age != '無'
GROUP BY tname, age
ORDER BY
	ARRAY_POSITION(ARRAY['北投區', '士林區', '內湖區', '南港區', '松山區', '信義區', '中山區', '大同區', '中正區', '萬華區', '大安區', '文山區']::varchar[], t.tname),
	ARRAY_POSITION(ARRAY['<=5年', '5-20年', '20-40年', '>40年'], t.age);
```

> **i01**
> To ensure the data is parsed correctly, it is necessary to order `x_axis` and `y_axis` in the SQL query for `three_d`, `percent`, and `time` query types.
>
> Additionally, ensure that zero values for subcategories are handled (if the value of a subcategory is 0, make sure the field is displayed, do not skip it). We recommend creating a temporary table that contains all xaxis-yaxis combinations and combining it with the query using a left join.

### percent

The `percent` query type shares the same format as the `three_d` query type, but with some additional restrictions on the data values. Refer to the [chart data article](/front-end/chart-data) in the front-end docs for more information.

**Sample Query String:**

```sql
-- For 'YouBike使用情況 youbike_availability'
SELECT
	'Youbike在站車輛' AS x_axis,
	unnest(ARRAY['可借車輛', '空位']) AS y_axis,
	unnest(ARRAY[sbi, bemp]) AS data FROM
	(
		SELECT sbi, bemp
		FROM app_calcu_hour_traffic_youbike
		WHERE bike_type = 2
		ORDER BY _ctime desc
		LIMIT 1
	) AS t
```

### time

**Target Query Result:**

```go
type TimeSeriesData struct {
	Xaxis time.Time `gorm:"column:x_axis"`
	Yaxis string    `gorm:"column:y_axis"`
	Data  float64   `gorm:"column:data"`
}
```

**Parsed Into:**

```json
[
	{
		"name": "",
		"data": [
			{ "x": "2023-05-25T06:29:00+08:00", "y": 17 },
			...
		]
	},
	...
]
```

**Sample Query String (Chart Data):**

```sql
-- For '建照使照發照量 building_license'
WITH date_range AS (
  SELECT
    '%s'::timestamp with time zone AS start_time,
    '%s'::timestamp with time zone AS end_time
)
SELECT * FROM (
	SELECT DATE_TRUNC('month', "發照日"::timestamp) AS x_axis, '建照' AS y_axis, COUNT(*) AS data
	FROM building_permit
	WHERE 發照日 BETWEEN (SELECT start_time FROM date_range) AND (SELECT end_time FROM date_range)
	GROUP BY x_axis
	UNION ALL
	SELECT DATE_TRUNC('month', "發照日"::timestamp) AS x_axis, '使照' AS y_axis, COUNT(*) AS data
	FROM building_license
	WHERE 發照日 BETWEEN (SELECT start_time FROM date_range) AND (SELECT end_time FROM date_range)
	GROUP BY x_axis
) AS t
ORDER BY y_axis, x_axis;
```

**Sample Query String (History Data):**

```sql
-- For '捷運人流趨勢 metro_passengers'
SELECT date_trunc('%s', sdatetime) AS x_axis, sum(outcount) AS data
FROM traffic_metro_capacity_realtime_history
WHERE sdatetime BETWEEN '%s' AND '%s'
GROUP BY x_axis
ORDER BY x_axis desc
```

### map_legend

**Target Query Result:**

```go
type MapLegendData struct {
	Name  string  `gorm:"column:name" json:"name"`
	Type  string  `gorm:"column:type" json:"type"`
	Icon  string  `gorm:"column:icon" json:"icon" OPTIONAL`
	Value float64 `gorm:"column:value" json:"value"`
}
```

**Sample Query String:**

```sql
-- For '居職人口推估 fet_work_live'
SELECT
	unnest(ARRAY['居住推估人數', '工作推估人數']) AS name,
	unnest(ARRAY[SUM(CASE pop_live WHEN null THEN 0 ELSE pop_live::NUMERIC END), SUM(CASE pop_work WHEN null THEN 0 ELSE pop_work::NUMERIC END)]) AS value,
	'fill-extrusion' as type
FROM tp_fet_work_live
```

## APIs

`GET` `/component/:id/chart`

_[Try out the API in our API Tester](/api)_

| Item         | Description                                                                                                |
| ------------ | ---------------------------------------------------------------------------------------------------------- |
| Permissions  | `Guest`                                                                                                    |
| Query Params | `timefrom` ---- Start time for the query. Optional.<br>`timeto` -------- End time for the query. Optional. |

**Response:**

```json
{
	"categories": [...], // If three_d or percent data
	"data": [...], // chart data,
	"status": "success"
}
```

`GET` `/component/:id/history`

_[Try out the API in our API Tester](/api)_

| Item         | Description                                                                                                |
| ------------ | ---------------------------------------------------------------------------------------------------------- |
| Permissions  | `Guest`                                                                                                    |
| Query Params | `timefrom` ---- Start time for the query. Required.<br>`timeto` -------- End time for the query. Required. |

**Response:**

```json
{
	"data": [...], // history data,
	"status": "success"
}
```
